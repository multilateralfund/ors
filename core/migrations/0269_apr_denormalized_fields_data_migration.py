# Generated by Django 4.2.17 on 2025-12-17 09:16

from django.db import migrations
from django.db.models import Prefetch


def populate_denormalized_fields(apps, schema_editor):
    """
    Populate denormalized fields for all existing AnnualProjectReport records.
    """
    # Import the real model here so we can access its methods and properties
    from core.models.annual_project_report import AnnualProjectReport

    existing_aprs = AnnualProjectReport.objects.select_related(
        "project__agency",
        "project__cluster",
        "project__country__parent",
        "project__project_type",
        "project__sector",
        "report__progress_report",
    )

    total = existing_aprs.count()
    updated = 0
    errors = 0

    print(f"\nPopulating denormalized fields for {total} APR records...")

    for i, apr in enumerate(existing_aprs, start=1):
        try:
            apr.populate_derived_fields()
            apr.save()
            updated += 1
            if i % 100 == 0:
                print(f"  Processed {i}/{total} records...")
        except Exception as e:
            errors += 1
            print(f"  Error processing APR {apr.id}: {e}")

    print(f"\nCompleted: Total={total}, Updated={updated}, Errors={errors}")


def reverse_populate(apps, schema_editor):
    """
    Reverse migration: clear all denormalized fields.
    """
    AnnualProjectReport = apps.get_model("core", "AnnualProjectReport")
    AnnualProjectReport.objects.update(
        meta_code_denorm=None,
        project_code_denorm=None,
        legacy_code_denorm=None,
        agency_name_denorm=None,
        cluster_name_denorm=None,
        region_name_denorm=None,
        country_name_denorm=None,
        type_code_denorm=None,
        sector_code_denorm=None,
        project_title_denorm=None,
        date_approved_denorm=None,
        date_completion_proposal_denorm=None,
        consumption_phased_out_odp_proposal_denorm=None,
        consumption_phased_out_co2_proposal_denorm=None,
        production_phased_out_odp_proposal_denorm=None,
        production_phased_out_co2_proposal_denorm=None,
        approved_funding_denorm=None,
        adjustment_denorm=None,
        approved_funding_plus_adjustment_denorm=None,
        per_cent_funds_disbursed_denorm=None,
        balance_denorm=None,
        support_cost_approved_denorm=None,
        support_cost_adjustment_denorm=None,
        support_cost_approved_plus_adjustment_denorm=None,
        support_cost_balance_denorm=None,
        implementation_delays_status_report_decisions_denorm=None,
        date_of_completion_per_agreement_or_decisions_denorm=None,
        pcr_due_denorm=None,
    )


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0268_annualprojectreport_adjustment_denorm_and_more"),
    ]

    operations = [
        migrations.RunPython(
            populate_denormalized_fields,
            reverse_populate,
        ),
    ]
